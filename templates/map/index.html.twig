{% extends 'base.html.twig' %}

{% block title %}Carte{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="display-4 text-center mb-5 text-primary">Points d'intérêt à Rouen</h1>

    <!-- Map Container -->
    <div id="map" class="rounded shadow-lg mb-4" style="height: 600px;"></div>

    <!-- Filter by Type Dropdown -->
    <div class="mb-4 text-center">
        <select id="service-filter" class="form-select form-select-lg">
            <option value="">Sélectionnez une catégorie</option>
            <option value="fast_food">🍔 Restauration rapide</option>
            <option value="boulangerie">🍞 Boulangerie</option>
            <option value="supermarche">🛒 Supermarché</option>
            <option value="centre_commercial">🏬 Centre commercial</option>
            <option value="fuel">⛽ Station-service</option>
            <option value="parking">🅿️ Parking</option>
            <option value="bicycle_rental">🚲 Location de vélos</option>
            <option value="pharmacy">💊 Pharmacie</option>
            <option value="hospital">🏥 Hôpital</option>
            <option value="cinema">🎥 Cinéma</option>
            <option value="theatre">🎭 Théâtre</option>
            <option value="nightclub">🎉 Boîte de nuit</option>
            <option value="library">📚 Bibliothèque</option>
            <option value="cafe">☕ Café</option>
            <option value="museum">🏛️ Musée</option>
            <option value="park">🌳 Parc</option>
            <option value="bank">🏦 Banque</option>
            <option value="atm">🏧 Distributeur</option>
            <option value="post_office">📮 Bureau de poste</option>
            <option value="school">🏫 École</option>
            <option value="hotel">🏨 Hôtel</option>
            <option value="toilets">🚻 Toilettes publiques</option>
            <option value="drinking_water">💧 Point d'eau potable</option>
        </select>
    </div>

    <!-- List of Places -->
    <h2 class="h3 mb-3" id="places-header" style="display: none;">Liste des lieux</h2>
    <div class="table-responsive" id="places-list-container" style="display: none;">
        <table class="table table-hover table-striped table-bordered">
            <tbody id="places-list">
                <tr>
                    <td colspan="3" class="text-center">Veuillez sélectionner une catégorie.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- CSS and JS for Leaflet & Bootstrap -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Initialize the map
    var map = L.map('map').setView([49.4431, 1.0993], 13);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Custom red marker for user location
    var userLocationIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    var userLocationMarker = L.marker([49.4431, 1.0993], { icon: userLocationIcon }).addTo(map);
    userLocationMarker.bindPopup("Vous êtes ici").openPopup();

    var markers = [];

    // Function to fetch and display services
    function fetchServices(filterType = '') {
        fetch(`/api/services?type=${filterType}`)
            .then(response => response.json())
            .then(data => {
                let placesList = document.getElementById('places-list');
                let placesListContainer = document.getElementById('places-list-container');
                let placesHeader = document.getElementById('places-header');
                placesList.innerHTML = ''; // Clear the current list

                // Clear existing markers from the map
                markers.forEach(marker => marker.remove());
                markers = [];

                if (data.length === 0) {
                    placesList.innerHTML = '<tr><td colspan="3" class="text-center">Aucun lieu trouvé.</td></tr>';
                    placesListContainer.style.display = 'block';
                    placesHeader.style.display = 'block';
                } else {
                    data.forEach(service => {
                        var marker = L.marker([service.latitude, service.longitude])
                            .addTo(map)
                            .bindPopup(`<b>${service.name}</b><br>${service.type}`);
                        markers.push(marker);

                        let row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="/place/${service.id}">${service.name}</a></td>
                            <td>${service.type}</td>
                            <td><button class="btn btn-sm btn-outline-danger favorite-btn" data-service="${service.type}">❤️</button></td>
                        `;
                        placesList.appendChild(row);
                    });
                    placesListContainer.style.display = 'block';
                    placesHeader.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des données:', error);
                document.getElementById('places-list').innerHTML = `
                    <tr><td colspan="3" class="text-center text-danger">Erreur lors du chargement des lieux.</td></tr>
                `;
            });
    }

    // Listen for changes on the filter dropdown
    document.getElementById('service-filter').addEventListener('change', function () {
        var selectedType = this.value;
        document.getElementById('places-list-container').style.display = 'none';
        document.getElementById('places-header').style.display = 'none';

        if (selectedType) {
            fetchServices(selectedType);
        } else {
            markers.forEach(marker => marker.remove());
            markers = [];
            userLocationMarker.addTo(map);
        }
    });
</script>

{% endblock %}