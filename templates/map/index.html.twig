{% extends 'base.html.twig' %}

{% block title %}Map - Find Nearby Services{% endblock %}

{% block body %}
<body>
    <div>
        <select id="categoryFilter">
            <option value="">All</option>
            <option value="restaurant">Restaurants</option>
            <option value="parking">Parking</option>
            <option value="post_office">Post Offices</option>
        </select>

        <input type="range" id="distanceFilter" min="500" max="10000" step="500" value="5000">
        <span id="distanceLabel">5 km</span>
    </div>

    <div id="map" style="height: 500px;"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([49.44313000, 1.09932000], 13); // Rouen
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        
        var userMarker = null;
        var servicesMarkers = [];

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;
                        var userCoords = L.latLng(userLat, userLng);

                        // Send user location to Symfony backend
                        fetch('/set-location', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ latitude: userLat, longitude: userLng })
                        });

                        // Add or update user marker
                        if (userMarker) {
                            userMarker.setLatLng(userCoords);
                        } else {
                            userMarker = L.marker(userCoords, {
                                icon: L.icon({
                                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34]
                                })
                            }).addTo(map).bindPopup('You are here').openPopup();
                        }

                        map.setView(userCoords, 13);
                        fetchServices();
                    },
                    function (error) {
                        alert('Geolocation failed: ' + error.message);
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        }

        function fetchServices() {
            let category = document.getElementById("categoryFilter").value;
            let distance = document.getElementById("distanceFilter").value;

            fetch(`/get-services?category=${category}&distance=${distance}`)
                .then(response => response.json())
                .then(data => {
                    // Remove old markers
                    servicesMarkers.forEach(marker => map.removeLayer(marker));
                    servicesMarkers = [];

                    data.forEach(service => {
                        let marker = L.marker([service.latitude, service.longitude]).addTo(map)
                            .bindPopup(`${service.name} (${service.type}) <br> Distance: ${service.distance.toFixed(2)}m <br> <a href="${service.url}" target="_blank">More info</a>`);
                        servicesMarkers.push(marker);
                    });
                })
                .catch(error => console.error('Error fetching services:', error));
        }

        // Filter controls
        document.getElementById("distanceFilter").oninput = function () {
            document.getElementById("distanceLabel").innerText = (this.value / 1000) + " km";
            fetchServices();
        };

        document.getElementById("categoryFilter").onchange = fetchServices;

        // "Find My Location" button
        var geoButton = document.createElement("button");
        geoButton.innerText = "Find My Location";
        geoButton.style.position = "absolute";
        geoButton.style.top = "10px";
        geoButton.style.left = "10px";
        geoButton.style.zIndex = "1000";
        geoButton.onclick = locateUser;
        document.body.appendChild(geoButton);
    </script>
</body>
{% endblock %}
