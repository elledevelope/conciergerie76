{% extends 'base.html.twig' %}

{% block title %}Hello MapController!{% endblock %}

{% block body %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Integration</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
    <div id="map" style="height: 500px;"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([49.44313000, 1.09932000], 13); // Rouen: latitude, longitude, and zoom level 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        
        // Markers and line
        var userMarker = null;
        var destinationMarker = null;
        var distanceLine = null;
        
        // Function to locate the user
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;
                        var userCoords = L.latLng(userLat, userLng);
        
                        // Add or update the user marker
                        if (userMarker) {
                            userMarker.setLatLng(userCoords);
                        } else {
                            userMarker = L.marker(userCoords, {
                                icon: L.icon({
                                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34]
                                })
                            }).addTo(map).bindPopup('You are here').openPopup();
                        }
        
                        // Center map on user's location
                        map.setView(userCoords, 13);
                    },
                    function(error) {
                        alert('Geolocation failed: ' + error.message);
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        }
        
        // Function to calculate distance and draw a line
        map.on('click', function(e) {
            if (!userMarker) {
                alert("Please allow geolocation first!");
                return;
            }
        
            var destinationCoords = e.latlng;
        
            // Add or update the destination marker
            if (destinationMarker) {
                destinationMarker.setLatLng(destinationCoords);
            } else {
                destinationMarker = L.marker(destinationCoords).addTo(map);
            }
        
            // Calculate distance in meters
            var distance = userMarker.getLatLng().distanceTo(destinationCoords);
        
            // Draw a line between user and destination
            if (distanceLine) {
                distanceLine.setLatLngs([userMarker.getLatLng(), destinationCoords]);
            } else {
                distanceLine = L.polyline([userMarker.getLatLng(), destinationCoords], { color: 'blue', weight: 3 }).addTo(map);
            }
        
            // Show distance in a dynamic popup
            destinationMarker.bindPopup('Distance from you: ' + distance.toFixed(2) + ' meters').openPopup();
        });
        
        // Add "Find My Location" button
        var geoButton = document.createElement("button");
        geoButton.innerText = "Find My Location";
        geoButton.style.position = "absolute";
        geoButton.style.top = "10px";
        geoButton.style.left = "10px";
        geoButton.style.zIndex = "1000";
        geoButton.onclick = locateUser;
        document.body.appendChild(geoButton);
        
    </script>
</body>
{% endblock %}